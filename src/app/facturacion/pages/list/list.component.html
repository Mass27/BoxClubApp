<h2 class="titulo-global">Listado de Facturas</h2>
<search-box-fac
  (buscarNombre)="buscarFacturasPorNombre($event)"
></search-box-fac>

<div class="button-agregar">
  <button routerLink="/facturacion/agregar">AGREGAR</button>
</div>


<div class="flex items-center justify-between">
  <div class="filtros-card">
    <div class="fecha-filtros-container">
      <mat-form-field class="fecha-filtro">
        <mat-label>Fecha de Inicio</mat-label>
        <input matInput [matDatepicker]="pickerInicio" [(ngModel)]="fechaInicio">
        <mat-datepicker-toggle matSuffix [for]="pickerInicio"></mat-datepicker-toggle>
        <mat-datepicker #pickerInicio></mat-datepicker>
      </mat-form-field>

      <mat-form-field class="fecha-filtro">
        <mat-label>Fecha de Fin</mat-label>
        <input matInput [matDatepicker]="pickerFin" [(ngModel)]="fechaFin">
        <mat-datepicker-toggle matSuffix [for]="pickerFin"></mat-datepicker-toggle>
        <mat-datepicker #pickerFin></mat-datepicker>
      </mat-form-field>
    </div>
  </div>

  <div class="flex space-x-4">
    <button mat-raised-button color="primary" (click)="buscarFacturasPorFechas()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded">
      Filtrar
    </button>
    <button mat-raised-button color="warn" (click)="limpiarFiltros()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded">
      Limpiar Filtros
    </button>
    <div class="export-button">
      <button mat-raised-button (click)="exportToExcel()"><mat-icon>file_download</mat-icon> Exportar a Excel</button>
    </div>
  </div>
</div>

<div  class="table-responsive">
  <table mat-table [dataSource]="facturasFiltradas">
    <!-- Definir las columnas -->

    <ng-container matColumnDef="nombreCliente">
      <th mat-header-cell *matHeaderCellDef> Nombre de Cliente </th>
      <td mat-cell *matCellDef="let factura">  {{ getclientesName(factura.idcliente) }} </td>
    </ng-container>

    <ng-container matColumnDef="numeroFactura">
      <th mat-header-cell *matHeaderCellDef>No. De Factura</th>
      <td mat-cell *matCellDef="let factura">{{ factura.numeroFactura }}</td>
    </ng-container>

    <ng-container matColumnDef="fecha">
      <th mat-header-cell *matHeaderCellDef>Fecha</th>
      <td mat-cell *matCellDef="let factura">
        {{ formatDate(factura.fecha) }}
      </td>
    </ng-container>

    <ng-container matColumnDef="metodoPago">
      <th mat-header-cell *matHeaderCellDef>MÃ©todo de Pago</th>
      <td mat-cell *matCellDef="let factura">{{ factura.metodoPago }}</td>
    </ng-container>

    <ng-container matColumnDef="plan">
      <th mat-header-cell *matHeaderCellDef>Plan</th>
      <td mat-cell *matCellDef="let factura">
        {{ getPlanName(factura.idPlan) }}
      </td>
    </ng-container>

    <ng-container matColumnDef="productos">
      <th mat-header-cell *matHeaderCellDef>Productos</th>
      <td mat-cell *matCellDef="let factura">
        {{ getProdName(factura.idproducto) }}
      </td>
    </ng-container>

    <ng-container matColumnDef="cantidadProductos">
      <th mat-header-cell *matHeaderCellDef>Cantidad de Productos</th>
      <td mat-cell *matCellDef="let factura">{{ factura.CantidadProducto }}</td>
    </ng-container>

    <ng-container matColumnDef="subTotal">
      <th mat-header-cell *matHeaderCellDef>SubTotal</th>
      <td mat-cell *matCellDef="let factura">Lps.{{ factura.subtotal | number}}</td>
    </ng-container>

    <ng-container matColumnDef="descuentos">
      <th mat-header-cell *matHeaderCellDef>Descuentos</th>
      <td mat-cell *matCellDef="let factura">{{ factura.descuento }}%</td>
    </ng-container>

    <ng-container matColumnDef="total">
      <th mat-header-cell *matHeaderCellDef>Total</th>
      <td mat-cell *matCellDef="let factura">Lps.{{ factura.totalPagar  | number}}</td>
    </ng-container>

    <ng-container matColumnDef="acciones" >
      <th mat-header-cell *matHeaderCellDef  >Editar</th>
      <td mat-cell *matCellDef="let factura"  >
        <button  *ngIf="isAdmin"
          mat-icon-button
          [routerLink]="['/facturacion/edit', factura._id]"
          class="edit-button"
        >
          <mat-icon>edit</mat-icon>
        </button>
      </td>
    </ng-container>

    <ng-container matColumnDef="imprimir">
      <th mat-header-cell *matHeaderCellDef>Imprimir</th>
      <td mat-cell *matCellDef="let factura">
        <button
          mat-icon-button
          [routerLink]="['/facturacion/imprimir', factura._id]"
          class="edit-button"
        >
          <mat-icon>print</mat-icon>
        </button>
      </td>
    </ng-container>
    <!-- Definir las filas -->
    <tr mat-header-row *matHeaderRowDef="columnas"></tr>
    <tr mat-row *matRowDef="let row; columns: columnas"></tr>
  </table>
  <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
  <div class="total-ingresos">
    <h3>Total de Ingresos: <span>Lps. {{ totalIngresos | number}}</span></h3>
  </div>
</div>
